<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Inflation Perception Survey</title>
  <!-- Add SheetJS library for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.2"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css">
</head>
<body>
  <div id="consent-text" style="display: none;">
    You are invited to participate in a research study about price of consumer products The purpose of this study is to explore people's perceptions of inflation rate.
If you agree to participate in this study, you will be asked to complete an online survey. The survey will take approximately 8~15 minutes to complete and will include a short training section. You will be asked to answer all of the questions based on your experience. Your participation in this study is entirely voluntary. You may choose not to participate or to withdraw from the study at any time without any penalty or loss of benefits to which you are otherwise entitled.
There are no anticipated risks associated with participating in this study. Your responses will be kept anonymous and confidential. All data collected will be used solely for research purposes. Your identity will not be linked to your responses, and any identifying information will not be collected.
By clicking on the "I Agree" button below, you acknowledge that you have read and understand the information provided above, and you voluntarily agree to participate in this study.
I have read and understood the above and hereby give my consent to take part in this experiment in full knowledge that data is being recorded.
  </div>
</body>
<script>
  // Initialize jsPsych with data export functionality
  const jsPsych = initJsPsych({
    on_finish: () => {
      // Get all trial data
      const data = jsPsych.data.get().values();
      
      // Process the data into a format suitable for Excel
      const processedData = data.map(trial => {
        try {
          let row = {
            'Trial Type': trial.trial_type || 'Unknown',
            'RT (ms)': trial.rt || '',
            'Time Elapsed': trial.time_elapsed || '',
            'Question': '',
            'Response': '',
            'Correct': ''
          };

          // Add response data based on trial type
          if (trial.trial_type === 'html-button-response') {
            // Safely extract question text from stimulus
            if (trial.stimulus) {
              row['Question'] = trial.stimulus
                .replace(/<[^>]*>/g, '')  // Remove HTML tags
                .replace(/\s+/g, ' ')     // Normalize whitespace
                .trim();
            }
            
            // Safely get response
            if (trial.response !== undefined && Array.isArray(trial.choices)) {
              row['Response'] = trial.choices[trial.response] || trial.response.toString();
            }
          } 
          else if (trial.trial_type === 'survey-text') {
            // Safely handle survey text responses
            if (trial.questions && trial.questions[0]) {
              row['Question'] = trial.questions[0].prompt || '';
            }
            if (trial.response && trial.response.cost_question) {
              row['Response'] = trial.response.cost_question;
            }
            row['Correct'] = trial.correct ? 'Yes' : 'No';
          }

          return row;
        } catch (error) {
          console.error('Error processing trial:', error);
          return {
            'Trial Type': 'Error',
            'RT (ms)': '',
            'Time Elapsed': '',
            'Question': 'Error processing trial data',
            'Response': '',
            'Correct': ''
          };
        }
      });

      // Filter out any null or undefined entries
      const cleanData = processedData.filter(row => row !== null && row !== undefined);

      // Create worksheet
      const ws = XLSX.utils.json_to_sheet(cleanData);
      
      // Create workbook and add worksheet
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Survey Results");
      
      // Generate Excel file and trigger download
      XLSX.writeFile(wb, "inflation_survey_results.xlsx");
      
      // Display data in console for verification
      console.log('Processed Data:', cleanData);
    }
  });

  const timeline = [];

  /* Question 1: UK residency */
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h3>1. Have you lived in the UK for the past 5 years?</h3>
    `,
    choices: ['Yes', 'No']
  });

  /* Question 2: Consent */
  let consentContent = document.querySelector('#consent-text').innerText;
  
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h3>2. Consent</h3>
      <div style="text-align: left; max-width: 800px;">
        ${consentContent}
      </div>
    `,
    choices: ['I agree', 'exit'],
    on_finish: data => {
      if (data.response == 1) {
        jsPsych.endExperiment('Thanks for your time');
      }
    }
  });

  /* Question 3: Sky color */
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h3>3. If you see a question that asks you the colour of the sky, you should answer 'green'.</h3>
    `,
    choices: ['RED', 'BLUE', 'GREEN']
  });

  /* Question 9: Cost question */
  const costQuestion = {
    type: jsPsychSurveyText,
    questions: [{
      prompt: "When production costs rise, the supply of goods will ______ (increase or decrease), leading to a ______ (1. rise or 2. fall) in the price level. If production costs continue to rise, businesses usually pass the costs on to consumers, ultimately resulting in a ______ (1. rise or 2. fall) in the overall price level. ( decrease, 2, 1,)",
      placeholder: "Space separated answers",
      name: "cost_question"
    }],
    on_finish: data => {
      const answers = (data.response.cost_question || '').split(' ');
      data.correct = answers[0] === 'decrease' && answers[1] === '2' && answers[2] === '1';
    }
  };

  timeline.push({
    timeline: [costQuestion, {
      conditional_function: () => {
        const last = jsPsych.data.get().last(1).values()[0];
        return !last.correct;
      },
      timeline: [{
        type: jsPsychHtmlButtonResponse,
        stimulus: "Perception and attitude of Inflation Rates……（ decrease, 2, 1,）",
        choices: ['next']
      }, costQuestion]
    }]
  });

  // Run the experiment
  jsPsych.run(timeline);
</script>
</html>
